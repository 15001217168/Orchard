using System;
using System.Collections.Generic;
using System.IO;
using System.Xml.Linq;
using NuGet;
using Orchard.ContentManagement.Handlers;
using Orchard.Localization;

namespace Orchard.ImportExport.Services {
    public interface IDeploymentPackageBuilder : IDependency {
        Stream BuildPackage(string packageName, XDocument recipe, IList<ExportedFileDescription> files);
    }

    public class DeploymentPackageBuilder : IDeploymentPackageBuilder {
        public Localizer T { get; set; }

        public DeploymentPackageBuilder() {
            T = NullLocalizer.Instance;
        }

        public Stream BuildPackage(string packageName, XDocument recipe, IList<ExportedFileDescription> files) {
            var context = new CreateContext {
                TargetPath = @"\Content\",
                Files = files
            };
            BeginPackage(context);
            try {
                SetCoreProperties(context, packageName);

                EmbedXmlFile(context, recipe, "export.xml");
                EmbedFiles(context);
            }
            finally {
                EndPackage(context);
            }

            if (context.Stream.CanSeek) {
                context.Stream.Seek(0, SeekOrigin.Begin);
            }

            return context.Stream;
        }

        private void SetCoreProperties(CreateContext context, string packageName) {
            context.Builder.Id = packageName;
            context.Builder.Version = new Version();
            context.Builder.Title = packageName;
            context.Builder.Description = T("{0} Deployment Package generated by Orchard", packageName).Text;
            context.Builder.Authors.Add(T("Orchard").Text);
        }
        
        private void EmbedFiles(CreateContext context) {
            foreach (var file in context.Files) {
                EmbedExportedFile(context, file);
            }
        }

        private static void BeginPackage(CreateContext context) {
            context.Stream = new MemoryStream();
            context.Builder = new PackageBuilder();
        }

        private static void EmbedExportedFile(CreateContext context, ExportedFileDescription fileDescription) {
            var file = new ExportedPackageFile(
                fileDescription, 
                context.TargetPath + fileDescription.LocalPath);
            context.Builder.Files.Add(file);
        }

        private static void EmbedXmlFile(CreateContext context, XDocument recipe, string path) {
            var file = new XmlPackageFile(recipe, context.TargetPath + path);
            context.Builder.Files.Add(file);
        }

        private static void EndPackage(CreateContext context) {
            context.Builder.Save(context.Stream);
        }

        private class CreateContext {
            public Stream Stream { get; set; }
            public PackageBuilder Builder { get; set; }

            public string TargetPath { get; set; }

            public IList<ExportedFileDescription> Files { get; set; }
        }

        private class ExportedPackageFile : IPackageFile {
            private readonly ExportedFileDescription _fileDescription;
            private readonly string _packagePath;

            public ExportedPackageFile(ExportedFileDescription fileDescription, string packagePath) {
                _fileDescription = fileDescription;
                _packagePath = packagePath;
            }

            public string Path { get { return _packagePath; } }

            [System.Diagnostics.CodeAnalysis.SuppressMessage("Microsoft.Reliability", "CA2000:Dispose objects before losing scope", Justification = "Supposed to return an open stream.")]
            public Stream GetStream() {
                return _fileDescription.Contents.OpenRead();
            }
        }

        private class XmlPackageFile : IPackageFile {
            private readonly XDocument _document;
            private readonly string _packagePath;

            public XmlPackageFile(XDocument document, string packagePath) {
                _document = document;
                _packagePath = packagePath;
            }

            public string Path { get { return _packagePath; } }

            [System.Diagnostics.CodeAnalysis.SuppressMessage("Microsoft.Reliability", "CA2000:Dispose objects before losing scope", Justification = "Supposed to return an open stream.")]
            public Stream GetStream() {
                var stream = new MemoryStream();
                _document.Save(stream);
                stream.Seek(0, SeekOrigin.Begin);
                return stream;
            }
        }
    }
}